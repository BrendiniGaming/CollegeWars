<!DOCTYPE html>
<html lang="en" class="h-full" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>College Wars</title>
    <link rel="manifest" href="../../resources/manifest.json">
    <link rel="icon" type="image/x-icon" href="../../resources/images/Favicon.svg">
    <link rel="canonical" href="https://collegewarsio.com/">
    <style>
        .preload * { transition: none !important; }
        html { visibility: visible; opacity: 1; }
        html.preload { visibility: hidden; opacity: 0; }
        .bg-image { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url("/images/EuropeBackgroundBlurred.webp"); background-size: cover; }
        .bg-image::before { content: ""; position: absolute; width: 100%; height: 100vh; background: rgba(30, 58, 138, 0.2); }
        .college-logo { font-family: 'Arial Black', sans-serif; font-size: 3rem; font-weight: 900; text-transform: uppercase; background: linear-gradient(to bottom, #FFD700, #DAA520); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5)); }
        
        /* Custom Styles for Discord Button Placement */
        .discord-auth-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; padding: 10px; }
        .discord-button {
            background-color: #5865F2; 
            color: white; 
            border-radius: 5px; 
            text-decoration: none; 
            font-weight: bold; 
            padding: 12px 20px;
            display: block;
            margin-top: 10px;
            max-width: 300px;
        }
        .rank-icon { height: 30px; width: 30px; margin-right: 8px; vertical-align: middle; }
        .auth-info-panel {
            background-color: #1f2937; padding: 15px; border-radius: 8px; color: white; min-width: 280px; text-align: center;
        }
    </style>
    <script>document.documentElement.className = "preload";</script>
</head>
<body class="h-full select-none font-sans min-h-screen bg-opacity-0 bg-cover bg-center bg-fixed flex flex-col">
    <header class="l-header">
        <div class="l-header__content flex flex-col items-center justify-center">
            <h1 class="college-logo">COLLEGE WARS</h1>
            <div id="game-version" class="l-header__highlightText text-center text-white/80 font-bold">BETA V1.0</div>
        </div>
    </header>
    <div class="bg-image"></div>
    
    <gutter-ads></gutter-ads>

    <main class="flex justify-center flex-grow">
        <div class="container pt-12">
            
            <div class="discord-auth-container">
                <div id="auth-status-panel" class="auth-info-panel">
                    <p id="auth-message">Checking session...</p>
                    <div id="auth-info"></div>
                    
                    <a id="discord-login-link" 
                       href="javascript:void(0)"
                       onclick="redirectToDiscord()"
                       class="discord-button" style="display: none;">
                        Sign in with Discord
                    </a>
                    <button id="logout-button" onclick="logout()" style="display: none; color: #F87171; background: none; border: none; text-decoration: underline; margin-top: 10px; font-size: 0.8em;">Logout</button>
                </div>
            </div>

            <div class="container__row">
                <flag-input class="w-[20%] md:w-[20%]"></flag-input>
                <territory-patterns-modal class="w-[20%] md:w-[15%]">
                    <button id="territory-patterns-input-preview-button" class="w-full border p-[4px] rounded-lg flex cursor-pointer border-black/30 dark:border-gray-300/60 bg-white/70 dark:bg-[rgba(55,65,81,0.7)] justify-center"></button>
                </territory-patterns-modal>
                <username-input class="relative w-full"></username-input>
                <news-button class="w-[20%] component-hideable"></news-button>
            </div>
            <div><public-lobby class="block"></public-lobby></div>
            <div><matchmaking-button class="w-[20%] md:w-[15%]"></matchmaking-button></div>
            <div class="container__row container__row--equal">
                <o-button id="host-lobby-button" title="Create Dorm Lobby" translationKey="main.create_lobby" block secondary></o-button>
                <o-button id="join-private-lobby-button" title="Join Class" translationKey="main.join_lobby" block secondary></o-button>
            </div>
            <o-button id="single-player" title="Solo Study Mode" translationKey="main.single_player" block></o-button>
            <o-button id="help-button" title="Syllabus" translationKey="main.instructions" block secondary></o-button>
            <div class="container__row"><lang-selector class="w-full"></lang-selector></div>
        </div>
    </main>

    <button 
        id="discord-login-btn" 
        title="Sign In" 
        onclick="redirectToDiscord()" 
        class="fixed bottom-4 right-4 z-50 rounded-full p-2 shadow-lg flex items-center justify-center" 
        style="width: 80px; height: 80px; background-color: #5865F2;"
    >
        <svg fill="white" viewBox="0 0 24 24" style="width: 50px; height: 50px;" xmlns="http://www.w3.org/2000/svg">
            <path d="M21.99 0H2.01C.9 0 0 .9 0 2.01v19.98C0 23.1 9 24 20 24h.99c1.1 0 2.01-.9 2.01-2.01V2.01c0-1.11-.9-2.01-2.01-2.01zM16.14 17.06c-1.63 1.34-3.69 2.01-5.75 2.01-2.06 0-4.12-.67-5.75-2.01-1.63-1.34-2.45-3.09-2.45-5.2V7.94c0-2.11.82-3.86 2.45-5.2 1.63-1.34 3.69-2.01 5.75-2.01s4.12.67 5.75 2.01c1.63 1.34 2.45 3.09 2.45 5.2v3.92c0 2.11-.82 3.86-2.45 5.2zm-5.75 1.57c-1.34 0-2.68-.34-4.02-1.01-1.34-.67-2.01-1.69-2.01-3.09V7.94c0-1.4.67-2.42 2.01-3.09 1.34-.67 2.68-1.01 4.02-1.01s2.68.34 4.02 1.01c1.34.67 2.01 1.69 2.01 3.09v3.92c0 1.4-.67 2.42-2.01 3.09-1.34.67-2.68 1.01-4.02 1.01z"/>
        </svg>
    </button>

<script>
    // --- GLOBAL UTILITY ---
    function getRankIconPath(rankTier) {
        // NOTE: Must ensure this directory exists and your 9 icons are named correctly
        return `/resources/images/ranks/rank_${rankTier.toLowerCase()}.png`;
    }

    // --- DISCORD AUTHENTICATION ---
    function redirectToDiscord() {
        const clientId = '1445564774266966097'; 
        const redirectUri = 'https://www.collegewarsio.com/api/discord/callback';
        const scope = 'identify email'; 
        
        const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${encodeURIComponent(scope)}`;
        window.location.href = authUrl;
    }

    // Shows user stats and unlocks the game buttons
    function showLoggedIn(user, token) {
        document.getElementById('discord-login-link').style.display = 'none';
        document.getElementById('logout-button').style.display = 'block';

        document.getElementById('auth-info').innerHTML = 
            `<img src="${getRankIconPath(user.rank_tier)}" alt="${user.rank_tier}" class="rank-icon">` + 
            `Welcome, <span style="color:#93C5FD; font-weight:bold;">${user.username}</span><br>` +
            `Tier: <span style="color:#4ADE80; font-weight:bold;">${user.rank_tier}</span> | Wins: ${user.wins}`;
        
        // Save token and username to LocalStorage for persistence
        localStorage.setItem('cw_token', token);
        localStorage.setItem('username', user.username);
        
        // CRITICAL: Unlock the game buttons
        injectUsername(user.username);
        observeGame();
    }

   // --- CRITICAL FIX: Robust URL Parsing ---
async function handleAuthRedirect() {
    const urlParams = new URLSearchParams(window.location.search);
    let token = localStorage.getItem("cw_token");

    const urlToken = urlParams.get('token');
    if (urlToken) {
        token = urlToken;
        localStorage.setItem('cw_token', token);
        window.history.replaceState({}, document.title, window.location.pathname); 
    }

    if (!token) {
        document.getElementById('auth-message').textContent = "Sign in to save progress";
        document.getElementById('discord-login-link').style.display = 'block';
        return;
    }

    document.getElementById('auth-message').textContent = "Restoring session...";
    try {
        const res = await fetch("/api/me", { headers: { "Authorization": `Bearer ${token}` } });
        const data = await res.json();
        if (res.ok) {
            showLoggedIn(data.user, token);
        } else {
            logout();
        }
    } catch {
        document.getElementById('auth-message').textContent = "Offline or Session check failed.";
    }
} // <-- make sure this brace closes the function

// Now define helpers OUTSIDE the function
function injectUsername(name) {
    localStorage.setItem("username", name);
    setTimeout(() => {
        const nativeInput = document.querySelector("username-input input");
        const customElement = document.querySelector("username-input");
        if (nativeInput) {
            nativeInput.value = name;
            nativeInput.dispatchEvent(new Event('input', { bubbles: true }));
            nativeInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (customElement) customElement.style.display = 'none';
    }, 500);
}

function logout() {
    localStorage.removeItem("cw_token");
    localStorage.removeItem("username");
    location.reload();
}

function observeGame() {
    // Placeholder for win event listeners
}

window.addEventListener("load", function() {
    requestAnimationFrame(() => document.documentElement.classList.remove("preload"));
    handleAuthRedirect();
});

    </script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"03d93e6fefb349c28ee9b408fa25a13"}'></script>
</body>
