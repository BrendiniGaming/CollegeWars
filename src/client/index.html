<!DOCTYPE html>
<html lang="en" class="h-full" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>College Wars</title>
    <link rel="manifest" href="../../resources/manifest.json">
    <link rel="icon" type="image/x-icon" href="../../resources/images/Favicon.svg">
    <link rel="canonical" href="https://collegewars.io/">
    <style>
        .preload * { transition: none !important; }
        html { visibility: visible; opacity: 1; }
        html.preload { visibility: hidden; opacity: 0; }
        .bg-image { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url("/images/EuropeBackgroundBlurred.webp"); background-size: cover; }
        .bg-image::before { content: ""; position: absolute; width: 100%; height: 100vh; background: rgba(30, 58, 138, 0.2); }
        .college-logo { font-family: 'Arial Black', sans-serif; font-size: 3rem; font-weight: 900; text-transform: uppercase; background: linear-gradient(to bottom, #FFD700, #DAA520); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5)); }
        
        /* Auth Box Styles */
        #auth-box { width: 100%; max-width: 400px; margin: 0 auto 20px auto; padding: 20px; background: rgba(17, 24, 39, 0.95); border: 1px solid rgba(59, 130, 246, 0.5); border-radius: 12px; color: white; backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative; z-index: 50; }
        #auth-box input { width: 100%; padding: 12px; margin-bottom: 12px; background: rgba(31, 41, 55, 0.8); border: 1px solid #4B5563; border-radius: 6px; color: white; font-size: 16px; }
        #auth-box button { width: 48%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; transition: transform 0.1s; }
        #auth-box button:active { transform: scale(0.98); }
        .btn-login { background: linear-gradient(135deg, #2563EB, #1D4ED8); } 
        .btn-enrol { background: linear-gradient(135deg, #059669, #047857); }
    </style>
    <script>document.documentElement.className = "preload";</script>
</head>
<body class="h-full select-none font-sans min-h-screen bg-opacity-0 bg-cover bg-center bg-fixed flex flex-col">
    <header class="l-header">
        <div class="l-header__content flex flex-col items-center justify-center">
            <h1 class="college-logo">COLLEGE WARS</h1>
            <div id="game-version" class="l-header__highlightText text-center text-white/80 font-bold">BETA V1.0</div>
        </div>
    </header>
    <div class="bg-image"></div>

    <main class="flex justify-center flex-grow">
        <div class="container pt-12">
            <div id="auth-box">
                <h3 style="text-align:center; margin-bottom:15px; color:#60A5FA; font-weight:bold; letter-spacing: 1px;">STUDENT PORTAL</h3>
                <div id="login-inputs">
                    <input id="login-email" type="email" placeholder="Student Email" />
                    <input id="login-pass" type="password" placeholder="Password" />
                    <div style="display:flex; justify-content:space-between;">
                        <button class="btn-login" onclick="login()">LOGIN</button>
                        <button class="btn-enrol" onclick="register()">ENROL</button>
                    </div>
                </div>
                <div id="auth-status" style="margin-top:15px; text-align:center; font-size:14px; min-height:20px; color: #93C5FD;">Checking session...</div>
            </div>

            <div class="container__row">
                <flag-input class="w-[20%] md:w-[20%]"></flag-input>
                <username-input class="relative w-full"></username-input>
            </div>
            <div><public-lobby class="block"></public-lobby></div>
            <div><matchmaking-button class="w-[20%] md:w-[15%]"></matchmaking-button></div>
            <div class="container__row container__row--equal">
                <o-button id="host-lobby-button" title="Create Dorm Lobby" translationKey="main.create_lobby" block secondary></o-button>
                <o-button id="join-private-lobby-button" title="Join Class" translationKey="main.join_lobby" block secondary></o-button>
            </div>
            <o-button id="single-player" title="Solo Study Mode" translationKey="main.single_player" block></o-button>
            <o-button id="help-button" title="Syllabus" translationKey="main.instructions" block secondary></o-button>
            <div class="container__row"><lang-selector class="w-full"></lang-selector></div>
        </div>
    </main>

    <button id="settings-button" title="Settings" class="fixed bottom-4 right-4 z-50 rounded-full p-2 shadow-lg transition-colors duration-300 flex items-center justify-center" style="width:80px;height:80px;background-color:#0075ff"><img src="../../resources/images/SettingIconWhite.svg" alt="Settings" style="width:72px;height:72px"/></button>
    <div id="customMenu" class="mt-4 sm:mt-6 lg:mt-8"><ul></ul></div>
    <div id="app"></div>
    <div id="radialMenu" class="radial-menu"></div>
    <div class="flex gap-2 fixed right-[10px] top-[10px] z-50 flex-col"><player-info-overlay></player-info-overlay></div>
    <div class="fixed bottom-[30px] sm:bottom-auto sm:top-[20px] z-50 mx-auto max-w-max inset-x-0 items-center"><heads-up-message></heads-up-message></div>
    <div class="bottom-0 w-full flex-col-reverse sm:flex-row z-50 md:w-[320px]" style="position:fixed;pointer-events:none">
        <div class="w-full md:w-2/3 md:fixed sm:right-0 md:bottom-0 md:flex flex-col items-end" style="pointer-events:none">
            <chat-display></chat-display>
            <events-display></events-display>
        </div>
        <div style="pointer-events:auto"><control-panel></control-panel></div>
    </div>

    <account-button></account-button><single-player-modal></single-player-modal><host-lobby-modal></host-lobby-modal><join-private-lobby-modal></join-private-lobby-modal><emoji-table></emoji-table><build-menu></build-menu><win-modal></win-modal><game-starting-modal></game-starting-modal><game-top-bar></game-top-bar><unit-display></unit-display><div class="flex fixed top-[20px] right-[20px] z-[1000] items-start gap-2"><replay-panel></replay-panel><game-right-sidebar></game-right-sidebar></div><settings-modal></settings-modal><player-panel></player-panel><spawn-timer></spawn-timer><help-modal></help-modal><dark-mode-button></dark-mode-button><stats-button></stats-button><alert-frame></alert-frame><chat-modal></chat-modal><user-setting></user-setting><multi-tab-modal></multi-tab-modal><game-left-sidebar></game-left-sidebar><flag-input-modal></flag-input-modal><performance-overlay></performance-overlay>
    <div id="language-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center"><div class="bg-white rounded-lg shadow-lg p-6 w-96 max-w-full"><h2 class="text-xl font-semibold mb-4">Select Language</h2><div id="language-list" class="space-y-2 max-h-80 overflow-y-auto"></div><button class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded" onclick="document.getElementById('language-modal').classList.add('hidden')">Close</button></div></div>

    <script>
    // --- AUTH LOGIC ---
    (async function() {
        const token = localStorage.getItem("cw_token");
        if (!token) { document.getElementById("auth-status").innerText = ""; return; }
        try {
            const res = await fetch("/api/me", { headers: { "Authorization": "Bearer " + token } });
            if (res.ok) { const data = await res.json(); showLoggedIn(data.user.username, data.user.wins); }
            else { localStorage.removeItem("cw_token"); document.getElementById("auth-status").innerText = "Session expired."; }
        } catch { document.getElementById("auth-status").innerText = "Offline mode."; }
    })();

    function showLoggedIn(username, wins) {
        document.getElementById("login-inputs").style.display = "none";
        document.getElementById("auth-status").innerHTML = `Welcome back, <span style="color:#93C5FD; font-size:1.1em; font-weight:bold;">${username}</span><br>Wins: <span style="color:#4ADE80; font-weight:bold;">${wins}</span><br><button onclick="logout()" style="background:none; border:none; color:#F87171; text-decoration:underline; cursor:pointer; margin-top:8px; font-size:12px;">Logout</button>`;
        injectUsername(username);
        observeGame();
    }

    // --- ROBUST INJECTION FIX ---
    function injectUsername(name) {
        localStorage.setItem("username", name);
        
        // Loop to check if the game input is ready
        let attempts = 0;
        const interval = setInterval(() => {
            const component = document.querySelector("username-input");
            const input = component ? component.querySelector("input") : null;
            
            if (input && component) {
                // Force value into game engine
                input.value = name;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                input.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true }));
                
                // Hide it only after filling it
                component.style.display = 'none';
                
                clearInterval(interval); // Stop checking
            }
            
            attempts++;
            if (attempts > 20) clearInterval(interval); // Stop after 10 seconds to save performance
        }, 500); // Check every half second
    }

    function logout() { localStorage.removeItem("cw_token"); location.reload(); }

    async function register(){const e=document.getElementById("login-email").value,p=document.getElementById("login-pass").value;if(!e||!p){document.getElementById("auth-status").innerText="Enter email & password";return}const u=prompt("Student Name:");if(!u)return;document.getElementById("auth-status").innerText="Enrolling...";try{const r=await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,email:e,password:p})}),d=await r.json();d.success?document.getElementById("auth-status").innerText="Success! Please Login.":document.getElementById("auth-status").innerText="Error: "+d.error}catch{document.getElementById("auth-status").innerText="Error"}}

    async function login(){const e=document.getElementById("login-email").value,p=document.getElementById("login-pass").value;if(!e||!p)return;document.getElementById("auth-status").innerText="Verifying...";try{const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:p})}),d=await r.json();d.success?(localStorage.setItem("cw_token",d.token),showLoggedIn(d.user.username,d.user.wins)):document.getElementById("auth-status").innerText="Failed: "+d.error}catch{document.getElementById("auth-status").innerText="Error"}}

    function observeGame() {
        const winModal = document.querySelector("win-modal");
        if (!winModal) return;
        new MutationObserver(() => {
            if (winModal.style.display !== "none" && winModal.offsetParent !== null && !window.hasRecordedWin) {
                reportWin(); window.hasRecordedWin = true;
            } else if(winModal.style.display === "none") { window.hasRecordedWin = false; }
        }).observe(winModal, { attributes: true, attributeFilter: ["style", "class"] });
    }

    async function reportWin() {
        const token = localStorage.getItem("cw_token");
        if (!token) return;
        await fetch("/api/update-stats", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ token: token, didWin: true }) });
        setTimeout(() => { const t=localStorage.getItem("cw_token"); if(t) fetch("/api/me", { headers: { "Authorization": "Bearer "+t } }).then(r=>r.json()).then(d=>showLoggedIn(d.user.username, d.user.wins)); }, 1000);
    }

    window.addEventListener("load", () => requestAnimationFrame(() => document.documentElement.classList.remove("preload")));
    </script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"03d93e6fefb349c28ee69b408fa25a13"}'></script>
</body>
</html>
