<!DOCTYPE html>
<html lang="en" class="h-full" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>College Wars</title>
    <link rel="manifest" href="../../resources/manifest.json">
    <link rel="icon" type="image/x-icon" href="../../resources/images/Favicon.svg">
    <link rel="canonical" href="https://collegewarsio.com/">
    <style>
        .preload * { transition: none !important; }
        html { visibility: visible; opacity: 1; }
        html.preload { visibility: hidden; opacity: 0; }
        .bg-image { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url("/images/EuropeBackgroundBlurred.webp"); background-size: cover; }
        .bg-image::before { content: ""; position: absolute; width: 100%; height: 100vh; background: rgba(30, 58, 138, 0.2); }
        .college-logo { font-family: 'Arial Black', sans-serif; font-size: 3rem; font-weight: 900; text-transform: uppercase; background: linear-gradient(to bottom, #FFD700, #DAA520); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5)); }
        
        .discord-auth-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; padding: 10px; }
        .discord-button {
            background-color: #5865F2; 
            color: white; 
            border-radius: 5px; 
            text-decoration: none; 
            font-weight: bold; 
            padding: 12px 20px;
            display: block;
            margin-top: 10px;
            max-width: 300px;
        }
        .rank-icon { height: 30px; width: 30px; margin-right: 8px; vertical-align: middle; }
        .auth-info-panel {
            background-color: #1f2937; padding: 15px; border-radius: 8px; color: white; min-width: 280px; text-align: center;
        }
    </style>
    <script>document.documentElement.className = "preload";</script>
</head>
<body class="h-full select-none font-sans min-h-screen bg-opacity-0 bg-cover bg-center bg-fixed flex flex-col">
    <!-- ... all your header, main, footer, modals etc. unchanged ... -->

<script>
    // --- GLOBAL UTILITY ---
    function getRankIconPath(rankTier) {
        return `/resources/images/ranks/rank_${rankTier.toLowerCase()}.png`;
    }

    // --- DISCORD AUTHENTICATION ---
    function redirectToDiscord() {
        const clientId = '1445564774266966097'; 
        const redirectUri = 'https://www.collegewarsio.com/api/discord/callback';
        const scope = 'identify email'; 
        
        const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${encodeURIComponent(scope)}`;
        window.location.href = authUrl;
    }

    function showLoggedIn(user, token) {
        document.getElementById('discord-login-link').style.display = 'none';
        document.getElementById('logout-button').style.display = 'block';

        document.getElementById('auth-info').innerHTML = 
            `<img src="${getRankIconPath(user.rank_tier)}" alt="${user.rank_tier}" class="rank-icon">` + 
            `Welcome, <span style="color:#93C5FD; font-weight:bold;">${user.username}</span><br>` +
            `Tier: <span style="color:#4ADE80; font-weight:bold;">${user.rank_tier}</span> | Wins: ${user.wins}`;
        
        localStorage.setItem('cw_token', token);
        localStorage.setItem('username', user.username);
        
        injectUsername(user.username);
        observeGame();
    }

    async function handleAuthRedirect() {
        const urlParams = new URLSearchParams(window.location.search);
        let token = localStorage.getItem("cw_token");

        // Handle Discord code
        const code = urlParams.get('code');
        if (code) {
            document.getElementById('auth-message').textContent = "Finishing login...";
            try {
                const res = await fetch(`/api/discord/callback?code=${encodeURIComponent(code)}`);
                const data = await res.json();

                if (res.ok && data && data.appToken && data.user) {
                    showLoggedIn(data.user, data.appToken);
                    localStorage.setItem("cw_token", data.appToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                } else {
                    document.getElementById('auth-message').textContent = "Login failed.";
                    document.getElementById('discord-login-link').style.display = 'block';
                }
            } catch {
                document.getElementById('auth-message').textContent = "Server error.";
                document.getElementById('discord-login-link').style.display = 'block';
            }
            return;
        }

        // Fallback: token in URL
        const urlToken = urlParams.get('token');
        const urlUsername = urlParams.get('username');
        const urlRank = urlParams.get('rankTier');
        const urlWins = urlParams.get('wins');

        if (urlToken) {
            token = urlToken;
            if (urlUsername && urlRank) {
                showLoggedIn({ username: urlUsername, rank_tier: urlRank, wins: urlWins }, token);
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
        }

        if (!token) {
            document.getElementById('auth-message').textContent = "Sign in to save progress";
            document.getElementById('discord-login-link').style.display = 'block';
            return;
        }

        // Verify existing token
        document.getElementById('auth-message').textContent = "Restoring session...";
        try {
            const res = await fetch("/api/me", { headers: { "Authorization": `Bearer ${token}` } });
            const data = await res.json();
            
            if (res.ok && data && data.user) {
                showLoggedIn(data.user, token);
            } else {
                logout();
            }
        } catch {
            document.getElementById('auth-message').textContent = "Offline or Session check failed.";
        }
    }
    
    function injectUsername(name) {
        localStorage.setItem("username", name);
        setTimeout(() => {
            const nativeInput = document.querySelector("username-input input");
            const customElement = document.querySelector("username-input");
            
            if (nativeInput) {
                nativeInput.value = name;
                nativeInput.dispatchEvent(new Event('input', { bubbles: true }));
                nativeInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
            if (customElement) customElement.style.display = 'none';
        }, 500);
    }

    function logout() {
        localStorage.removeItem("cw_token");
        localStorage.removeItem("username");
        location.reload();
    }

    function observeGame() {
        // Placeholder for win event listeners
    }

    window.addEventListener("load", function() {
        requestAnimationFrame(() => document.documentElement.classList.remove("preload"));
        handleAuthRedirect();
    });
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"03d93e6fefb349c28ee9b408fa25a13"}'></script>
</body>
</html>
